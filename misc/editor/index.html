<!DOCTYPE html>
<html>
<head>
	<!-- Standard Meta -->
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

	<!-- Site Properties -->
	<title>X-Words Grammar</title>

	<link rel="stylesheet" type="text/css" href="../../libs/Semantic-UI-CSS/components/reset.css">

	<script src="../../libs/jquery.min.js" ></script>

	<style type="text/css">

	body {
		width: 100%;
		height: 100%;
		position: absolute;
	}

	#editor-toolbar {
		position: absolute;
		top: 0;
		height: 4em;
		left: 0;
		width: 100%;
		background-color: #999;
	}
	.toolbar-btn {
		height: 100%;
	}

	#editor-content {
		position: absolute;
		top:4em;
		left:0;
		width: 100%;
		bottom:0;
	}

	#text-input {
		position: absolute;
		top: 0;
		left: 0;
		width: 50%;
		height: 100%;
		border: none;
		font-size: 1.5em;
		padding: 1em;
	}
	
	#text-preview {
		position: absolute;
		top: 0;
		right: 0;
		bottom: 0;
		width: 50%;
		background-color: #DDD;
		font-size: 1.5em;
		padding: 1em;
		overflow: scroll;
	}

	</style>

	<style>
	.hidden-do { border-bottom: 2px dashed #F00; }
	.hidden-does { border-bottom: 2px dashed #F00; }
	.hidden-did { border-bottom: 2px dashed #F00; }
	.infinitive {border: 2px dashed #880; border-radius: 1em;}
	.past-participle {border-bottom: 2px dashed #F00;}
	.extra-information {border-bottom: 1px dotted #000;}
	.verb { border-bottom: 2px solid #F00; }
	.xword {font-weight:bold; border-bottom: 2px solid #00F;}
	.subject { border: 2px solid #0F0 }
	.trunk {background-color: #DFF}
	.linker {background-color: #FFD}
	.joiner {background-color: #DDB}
	.shifter {background-color: #FDF}
	.front-shifter {background-color: #FDF}
	.end-shifter {background-color: #FDF}
	</style>
	
</head>
<body>
	<div id="editor-toolbar">
		<button class="toolbar-btn" id="btn-clear-markdown">Clear markdown</button>
		<button class="toolbar-btn" id="btn-automark">Auto mark</button>
	</div>
	<div id="editor-content">
		<textarea id="text-input">
(hidden-do)[vxo]

(hidden-does)[vxs]

(hidden-did)[vxd]

(infinitive)[inf]

(past-participle)[dtn]

(extra-information)[extra]

verb[v]

xword[x]

subject[s]

trunk[t]

linker[l]

joiner[j]

shifter[s]

(front-shifter)[f]

(end-shifter)[e]
		</textarea>
		<div id="text-preview"></div>

	</div>

<script>

function highlight_guess( text, words, premark, postmark ){
	var new_text = text;
	for( var i=0, l=words.length; i<l; i+=1 ){
		var re = new RegExp( '\\b'+words[i]+'\\b', 'gi' );
		new_text =  new_text.replace(re,function(capture){return premark+capture+postmark});
	}
	return new_text;
}

var tokens = {
	
	'vxo': '<span class="hidden-do">|</span>',
	'hidden-do': '<span class="hidden-do">|</span>',
	
	'vxs': '<span class="hidden-does">|</span>',
	'hidden-does': '<span class="hidden-does">|</span>',
	
	'vxd': '<span class="hidden-did">|</span>',
	'hidden-did': '<span class="hidden-did">|</span>',
	
	'inf': '<span class="infinitive">|</span>',
	'infinitive': '<span class="infinitive">|</span>',
	
	'dtn': '<span class="past-participle">|</span>',
	'past-participle': '<span class="past-participle">|</span>',
	
	'extra': '<span class="extra-information">|</span>',
	'extra-info': '<span class="extra-information">|</span>',
	
	'v': '<span class="verb">|</span>',
	'verb': '<span class="verb">|</span>',
	
	'x': '<span class="xword">|</span>',
	'xword': '<span class="xword">|</span>',
	
	's': '<span class="subject">|</span>',
	'subject': '<span class="subject">|</span>',
	
	't': '<span class="trunk">|</span>',
	'trunk': '<span class="trunk">|</span>',
	
	'l': '<span class="linker">|</span>',
	'linker': '<span class="linker">|</span>',
	
	'j': '<span class="joiner">|</span>',
	'joiner': '<span class="joiner">|</span>',
	
	'sh': '<span class="shifter">|</span>',
	'shifter': '<span class="shifter">|</span>',
	
	'f': '<span class="front-shifter">|</span>',
	'front-shifter': '<span class="front-shifter">|</span>',
	
	'e': '<span class="end-shifter">|</span>',
	'end-shifter': '<span class="end-shifter">|</span>'
};

function parse_text( text, tokens ){

	var replace_function = function(match, text, identifier, offset, string){
		if( ! tokens.hasOwnProperty( identifier ) ){
			throw ('Identifier: ['+identifier+'] is unknown. (TODO: add list of valid identifiers)');
		}
		
		return tokens[identifier].replace('|',text);
	};

	var single_word_regexp = /(\w+?)\[(.+?)\]/g;
	var parenthetical_regexp = /\((.+?)\)\[(.+?)\]/g;
	var curly_bracket_regexp = /\{(.+?)\}\[(.+?)\]/g;
	var regexps = [
		single_word_regexp,
		parenthetical_regexp,
		curly_bracket_regexp
	];
	
	var output = text;
	for( var i=0, l=regexps.length; i<l; i+=1 ){
		output = output.replace( regexps[i], replace_function );
	}
	
	return output.replace(/\n\n/g,'<br/>');
}

$(function(){
	setInterval( function(){
		$('#text-preview').html( parse_text( $('#text-input').val(), tokens ) );
	}, 50 );

	$('#btn-automark').on('click',function(){
		// highlight_guess( text, words, premark, postmark )
		var always_xwords_single = 'could would should shall must might may'.split(' ');
		var always_xwords_group = "couldn't won't wouldn't shouldn't don't doesn't didn't haven't hasn't hadn't".split(' ');
		var sometimes_xwords_single = "can will have has had am is are was were".split(' ');
		var sometimes_xwords_group = "can't isn't aren't wasn't".split(' ');

		var txt = highlight_guess( $('#text-input').val(), always_xwords_single, '', '[x]' );
		txt = highlight_guess( txt, always_xwords_group, '(', ')[x]' );
		txt = highlight_guess( txt, sometimes_xwords_single, '', '[x]' );
		txt = highlight_guess( txt, sometimes_xwords_group, '(', ')[x]' );

		$('#text-input').val(txt);
	});

	$('#btn-clear-markdown').on('click',function(){
		var txt = $('#text-input').val();
		txt = txt.replace( /\(/gi, '' );
		txt = txt.replace( /\)/gi, '' );
		txt = txt.replace( /\{/gi, '' );
		txt = txt.replace( /\}/gi, '' );
		txt = txt.replace( /\[.*?\]/gi, '' );
		$('#text-input').val(txt);
	});
});

</script>

</body>

</html>
