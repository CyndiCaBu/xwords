<!DOCTYPE html>
<html>
<head>
	<!-- Standard Meta -->
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

	<!-- Site Properties -->
	<title>X-Words Grammar</title>

	<link rel="stylesheet" type="text/css" href="../libs/Semantic-UI-CSS/components/reset.css">
	<link rel="stylesheet" type="text/css" href="../libs/Semantic-UI-CSS/components/site.css">

	<link rel="stylesheet" type="text/css" href="../libs/Semantic-UI-CSS/components/container.css">
	<link rel="stylesheet" type="text/css" href="../libs/Semantic-UI-CSS/components/grid.css">
	<link rel="stylesheet" type="text/css" href="../libs/Semantic-UI-CSS/components/header.css">
	<link rel="stylesheet" type="text/css" href="../libs/Semantic-UI-CSS/components/image.css">
	<link rel="stylesheet" type="text/css" href="../libs/Semantic-UI-CSS/components/menu.css">

	<link rel="stylesheet" type="text/css" href="../libs/Semantic-UI-CSS/components/divider.css">
	<link rel="stylesheet" type="text/css" href="../libs/Semantic-UI-CSS/components/list.css">
	<link rel="stylesheet" type="text/css" href="../libs/Semantic-UI-CSS/components/segment.css">
	<link rel="stylesheet" type="text/css" href="../libs/Semantic-UI-CSS/components/dropdown.css">
	<link rel="stylesheet" type="text/css" href="../libs/Semantic-UI-CSS/components/icon.css">
	<link rel="stylesheet" type="text/css" href="../libs/Semantic-UI-CSS/components/transition.css">

	<link rel="stylesheet" type="text/css" href="../libs/Semantic-UI-CSS/semantic.min.css">
	<link rel="stylesheet" type="text/css" href="../style/main.css">
	<link rel="stylesheet" type="text/css" href="../style/xwords.css">

	<script src="../libs/jquery.min.js" ></script>
	<script src="../libs/Semantic-UI-CSS/semantic.min.js"></script>
	<script src="../libs/list.js"></script>

	<script src="../libs/Semantic-UI-CSS/components/transition.js"></script>
	<script src="../libs/Semantic-UI-CSS/components/dropdown.js"></script>
	<script src="../libs/Semantic-UI-CSS/components/visibility.js"></script>
	<script>
	$(document)
		.ready(function() {

			// fix main menu to page on passing
			$('.main.menu').visibility({
				type: 'fixed'
			});
			$('.overlay').visibility({
				type: 'fixed',
				offset: 80
			});

			// lazy load images
			$('.image').visibility({
				type: 'image',
				transition: 'vertical flip in',
				duration: 500
			});

			// show dropdown on hover
			$('.main.menu	.ui.dropdown').dropdown({
				on: 'hover'
			});
		})
	;
	</script>

	<style type="text/css">

	body {
		background-color: #FFFFFF;
	}
	.main.container {
		margin-top: 2em;
	}

	.main.menu {
		margin-top: 4em;
		border-radius: 0;
		border: none;
		box-shadow: none;
		transition:
			box-shadow 0.5s ease,
			padding 0.5s ease
		;
	}
	.main.menu .item img.logo {
		margin-right: 1.5em;
	}

	.overlay {
		float: left;
		margin: 0em 3em 1em 0em;
	}
	.overlay .menu {
		position: relative;
		left: 0;
		transition: left 0.5s ease;
	}

	.main.menu.fixed {
		background-color: #FFFFFF;
		border: 1px solid #DDD;
		box-shadow: 0px 3px 5px rgba(0, 0, 0, 0.2);
	}
	.overlay.fixed .menu {
		left: 800px;
	}

	.text.container .left.floated.image {
		margin: 2em 2em 2em -4em;
	}
	.text.container .right.floated.image {
		margin: 2em -4em 2em 2em;
	}

	.ui.footer.segment {
		margin: 5em 0em 0em;
		padding: 5em 0em;
	}

	.verb {
		
	}
	.xw-hidden-does {
		border-bottom: 1px dashed #FF0;
	}
	.xw-hidden-did {
		border-bottom: 1px dashed #0FF;
	}
	.xw-found {
		background-color: #0F0;
	}

	</style>

</head>
<body>

	<div class="ui main text container">
		<h1 class="ui header" id="article-title"></h1>
		<img id="article-image" class="ui centered medium image" src="">
	</div>


	<div class="ui borderless main menu">
		<div class="ui text container">
			<div href="#" class="header item">
				<img id="article-icon" class="logo" src="">
			</div>

			<a href="../x-words" class="ui dropdown item">
				Find the Hidden Did (<div><span id="x-words-found"></span>/<span id="x-words-total"></span></div>)
				<i class="dropdown icon"></i>
				<div class="menu">
					<div class="item">Verbs and X-Words</div>
					<div class="item">Hidden X-Words</div>
					<div class="item">Subjects and X-Words</div>
					<div class="item">Verbs</div>
					<div class="item">Sentence Patterns</div>
					<div class="divider"></div>
					<div class="header">Help</div>
					<div class="item">
						<i class="dropdown icon"></i>
						What are X-Words
						<div class="menu">
							<div class="item">Blah blah</div>
							<div class="item">Bloopity Bloop Bleep</div>
						</div>
					</div>
					<div class="item">Hints</div>
				</div>
			</a>

			<span class="item divider">/</span>
			<a class="item" id="breadcrumb-category" class="section"></a>
			<span class="item divider">/</span>
			<div class="item" id="breadcrumb-article" class="active section"></div>
		</div>
	</div>

	<div class="ui text container">
		<div class="x-words-content">
			
			<p>
			Two things happened to me recently to remind me that nature is with us everywhere, even in an urban environment. As I was walking down the street with a friend, I felt my foot hit something lightly. I am so glad that I was wearing good sneakers, because when I looked down I saw a very small rat running away from us. It ran straight across our path and into a hole in the sidewalk. Although my friend and I walk down that street all the time, I never noticed that hole in the sidewalk before that night. It was just a crack in the cement, next to some stairs, but it was big enough for the rat to fit through. It made me think about the creatures that live under our feet, the ones we don't even know about.
			</p>

			<p>
			The next morning I noticed a bird outside the kitchen window. It was sitting on a branch the way the mourning doves do, but it looked much bigger. I wanted to take a picture, so I moved very slowly and carefully in case it could sense my presence. However, it flew away before I could get the camera ready. I decided to go outside to see if I could find it somewhere. Luckily, it was sitting in another tree nearby. I got a few pictures of it sitting on the branch way over my head, before it flew away again. I really hope that it found one of the local rats and had a good meal.
			</p>

			<p>
			I don't know what type of hawk this is, but I'm sure someone else does. If you are a bird watcher or if you've studied birds and you can identify this one, please send us a comment to let us know. Thanks!
			</p>

		</div>
		<p></p>
	</div>

	<div class="ui inverted vertical footer segment">
		<div class="ui center aligned container">
			<div class="ui stackable inverted divided grid">
				<div class="three wide column">
					<h4 class="ui inverted header">Group 1</h4>
					<div class="ui inverted link list">
						<a href="#" class="item">Link One</a>
						<a href="#" class="item">Link Two</a>
						<a href="#" class="item">Link Three</a>
						<a href="#" class="item">Link Four</a>
					</div>
				</div>
				<div class="three wide column">
					<h4 class="ui inverted header">Group 2</h4>
					<div class="ui inverted link list">
						<a href="#" class="item">Link One</a>
						<a href="#" class="item">Link Two</a>
						<a href="#" class="item">Link Three</a>
						<a href="#" class="item">Link Four</a>
					</div>
				</div>
				<div class="three wide column">
					<h4 class="ui inverted header">Group 3</h4>
					<div class="ui inverted link list">
						<a href="#" class="item">Link One</a>
						<a href="#" class="item">Link Two</a>
						<a href="#" class="item">Link Three</a>
						<a href="#" class="item">Link Four</a>
					</div>
				</div>
				<div class="seven wide column">
					<h4 class="ui inverted header">Footer Header</h4>
					<p>Extra space for a call to action inside the footer that could help re-engage users.</p>
				</div>
			</div>
			<div class="ui inverted section divider"></div>
			<img src="assets/images/logo.png" class="ui centered mini image">
			<div class="ui horizontal inverted small divided link list">
				<a class="item" href="#">Site Map</a>
				<a class="item" href="#">Contact Us</a>
				<a class="item" href="#">Terms and Conditions</a>
				<a class="item" href="#">Privacy Policy</a>
			</div>
		</div>
	</div>

	<!--
	<script type="text/javascript" src="../js/x-words.js"></script>
	<script type="text/javascript" src="../js/main-verbs.js"></script>
	-->

<script>

	function parse_tsv( text ){
		var lines = text.split('\n');
		var headings = lines[0].split('\t');
		var obj = {headings:headings};
		for( var j=0, c=headings.length; j<c; j+= 1){
			obj[headings[j]] = [];
		}
		for( var i=1, r=lines.length; i<r; i+=1 ){
			var cols = lines[i].split('\t');
			for( var j=0, c=headings.length; j<c; j+= 1){
				obj[headings[j]].push(cols[j]);
			}
		}
		return obj;
	}

	// The forms of verbs are: base, vxs, vxd, dtn, ing
	var verbs;
	$.ajax('verbs.txt',{contentType:'text/plain'}).then(function(response){
		verbs = parse_tsv( response );
		setTimeout(function(){
			mark_all_hidden_x_words();
			XWords.setup('.x-words-content');
		}, 500 );
	});

	// Shifters
	var shifters;
	$.ajax('shifters.txt',{contentType:'text/plain'}).then(function(response){
		shifters = response.toLowerCase().split('\n');
		console.info( shifters );
	});

	// Linkers
	var linkers;
	$.ajax('linkers.txt',{contentType:'text/plain'}).then(function(response){
		linkers = response.toLowerCase().split('\n');
		console.info( linkers );
	});

	// X-Words
	var xwords;
	$.ajax('xwords.txt',{contentType:'text/plain'}).then(function(response){
		xwords = response.toLowerCase().split('\n');
		console.info( xwords );
	});

	function mark_all_verbs(){
		// Find all the verbs
		$('p').each(function(i,el){
			// USE: (?!the|a|an|my|your|his|her|its|our|their)(?:\W+)(verbed)\b
			// to match all of the verbs that are actually adjectives and then
			// replace them with something that cannot be mistaken for a verb
			// then mark verbs then unreplace them
			var tmp = el.innerHTML;
			for( var i=0, l=verbs.headings.length; i<l; i+=1 ){
				var heading = verbs.headings[i];
				for( var j=0, jl=verbs[heading].length; j<jl; j+=1 ){
					var verb = verbs[heading][j];
					tmp = tmp.replace(new RegExp('\\b'+verb+'\\b','gi'),' <span class="verb">'+verb+'</span> ');
				}
			}
			console.info('aaa');
			el.innerHTML = tmp;
			//console.info( el.innerHTML );
		});
	}

	function mark_all_hidden_x_words(){
		// Find all the hidden x-words
		$('p').each(function(i,el){
			var tmp = el.innerHTML;

			// HIDDEN DID: any past-tense verb has a hidden did (x-word)
			// METHOD A (more words highlighted than B)
			/*
			var vxd = verbs['vxd'];
			for( var i=0, l=vxd.length; i<l; i+=1 ){
				var verb = vxd[i];
				tmp = tmp.replace(new RegExp('\\b('+verb+')\\b','gi'),' <span class="verb xw-hidden-did">'+verb+'</span> ');
			}

			// HIDDEN DOES: any present-tense verb in the vxs list has a hidden does (x-word)
			var vxs = verbs['vxs'];
			for( var i=0, l=vxs.length; i<l; i+=1 ){
				var verb = vxs[i];
				tmp = tmp.replace(new RegExp('\\b'+verb+'\\b','gi'),' <span class="verb xw-hidden-does">'+verb+'</span> ');
			}
			*/

			/*
			 * New algorithm for marking hidden verbs.
			 *
			 * The new version of Squink which has special features shows potential.
			 * 
			 * The machine really works in an environment that uses air conditioning.
			 * In an environment that uses air conditioning the machine really works.
			 *
			 * 1) Get a list of all verbs in a sentence
			 * 2) Remove any that are closest (just to the right of (that|which|who--list of shifters))
			 * 3) The rightmost verb that hasnt been removed is the "verb"
			 *
			 * He treats the patient who owes him money.
			 */
			
			function highlight( sentence ){
				// get verbs
				var regex = new RegExp( '\\b('+shifters.join('|')+'){0,1}.*?('+verbs['vxd'].join('|')+')\\b', 'g' );
				var match = regex.exec(sentence);
				while( match ){
					// match[0] = (shifters){0,1}.*?(verbs) // full thing
					// match[1] = shifters // underfined if no shifter
					// match[2] = verbs // always will be a verb
					if( match[1] ){
						continue;
					}else{
						break;
						// return match;
					}
				}
				if( match === null ){
					return sentence;
				}
				var verb_part = match[0].replace(match[2],'<span class="verb xw-hidden-did">'+match[2]+'</span>');
				return sentence.replace( match[0], verb_part );
			}
			
			// Split at sentences
			var sentences = tmp.replace(/([.,?!]+)/g,'____$1__').split(/____/g);
			for( var i=0, l=sentences.length; i<l; i+=1 ){
				sentences[i] = highlight(sentences[i]);
			}
			el.innerHTML = sentences.join('____').replace(/__/g,'');
			
			//el.innerHTML = tmp;

			
			//console.info( el.innerHTML );
		});
	}

	var XWords = {};
	XWords.loadContent = function( url ){};
	XWords.setup = function( content ){
		$(content).on('click','.xw-hidden-did',function(){
			$(this).addClass( 'xw-found' );
			updateCounts( content );
		});
		updateCounts( content );
	};
	XWords.total = function( content ){
		return $(content).find( '.xw-hidden-did' ).length;
	};
	XWords.numberFound = function( content ){
		return $(content).find( '.xw-found' ).length;
	};


	function updateCounts(content){
		// Update global word count
		var total = XWords.total(content);
		$('#x-words-total').html( total );
		$('#x-words-found').html( XWords.numberFound(content) );
		// Update per-paragraph word count
		$(content).find('span').remove('.xw-paragraph-summary');
		$(content).find('p, li').each(function(i,node){
			var total = XWords.total( node );
			if( total === 0 ){ return; }
			var found = XWords.numberFound( node );
			$( node ).append( '<span class="xw-paragraph-summary"><br/>'+found+' of '+total+' "hidden dids" found</span>' );
		});
	}

  </script>

</body>

</html>
